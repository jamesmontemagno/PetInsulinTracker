<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PetInsulinTracker.ViewModels"
             xmlns:models="clr-namespace:PetInsulinTracker.Models"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="PetInsulinTracker.Views.SchedulePage"
             x:DataType="vm:ScheduleViewModel"
             Title="Schedules"
             BackgroundColor="{DynamicResource PageBackground}">

    <Grid RowDefinitions="Auto,*" Padding="20" RowSpacing="12">

            <!-- Add New Schedule -->
            <VerticalStackLayout Grid.Row="0" Spacing="12">
                <VerticalStackLayout IsVisible="{Binding CanEdit}" Spacing="12">
                    <Label Text="SCHEDULE DETAILS" Style="{StaticResource OverlineStyle}" />

                    <Border Style="{StaticResource CardStyle}">
                        <VerticalStackLayout Spacing="12">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Label" Style="{StaticResource FormLabelStyle}" />
                                <Entry Text="{Binding Label}" Placeholder="e.g., Morning Insulin" />
                                <Label Text="Required to save" FontSize="12" TextColor="{DynamicResource Tertiary}"
                                       IsVisible="{Binding Label, Converter={StaticResource IsNotNullOrEmptyConverter}, ConverterParameter=invert}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Spacing="4">
                                <Label Text="Type" Style="{StaticResource FormLabelStyle}" />
                                <Picker ItemsSource="{Binding ScheduleTypeOptions}"
                                        SelectedItem="{Binding ScheduleType}" />
                            </VerticalStackLayout>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                    <Label Text="Time" Style="{StaticResource FormLabelStyle}" />
                                    <TimePicker Time="{Binding TimeOfDay}" Format="h:mm tt" />
                                </VerticalStackLayout>
                                <VerticalStackLayout Grid.Column="1" Spacing="4">
                                    <Label Text="Remind (min before)" Style="{StaticResource FormLabelStyle}" />
                                    <Entry Text="{Binding ReminderLeadTimeMinutes}" Keyboard="Numeric" />
                                </VerticalStackLayout>
                            </Grid>

                            <HorizontalStackLayout Spacing="6" IsVisible="{Binding IsSyncing}" HorizontalOptions="Center">
                                <ActivityIndicator IsRunning="{Binding IsSyncing}" HeightRequest="14" WidthRequest="14"
                                                 Color="{DynamicResource Primary}" />
                                <Label Text="Syncing…" FontSize="12" VerticalOptions="Center"
                                       TextColor="{DynamicResource Primary}" />
                            </HorizontalStackLayout>

                            <Button Text="{Binding SaveButtonText}" Command="{Binding SaveScheduleCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    HorizontalOptions="Fill"
                                    IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}" />

                            <Button Text="Cancel" Command="{Binding CancelEditCommand}"
                                    Style="{StaticResource OutlineButtonStyle}"
                                    HorizontalOptions="Fill"
                                    IsVisible="{Binding IsEditing}" />
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <Label Text="View-only access" Style="{StaticResource SubtleTextStyle}" FontSize="12"
                       IsVisible="{Binding CanEdit, Converter={StaticResource InvertedBoolConverter}}" />
            </VerticalStackLayout>

            <!-- Existing Schedules -->
            <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="12">
            <Label Text="ACTIVE SCHEDULES" Style="{StaticResource OverlineStyle}" Margin="0,8,0,0" />

            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Schedules}"
                                 BindableLayout.EmptyView="No schedules yet"
                                 Spacing="8">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:Schedule">
                        <SwipeView IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type vm:ScheduleViewModel}}, x:DataType=vm:ScheduleViewModel, Path=CanEdit}">
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Delete"
                                               BackgroundColor="{DynamicResource CurrentDanger}"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ScheduleViewModel}}, x:DataType=vm:ScheduleViewModel, Path=DeleteScheduleCommand}"
                                               CommandParameter="{Binding .}"
                                               IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:ScheduleViewModel}}, x:DataType=vm:ScheduleViewModel, Path=CanEdit}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Style="{StaticResource CardStyle}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ScheduleViewModel}}, x:DataType=vm:ScheduleViewModel, Path=EditScheduleCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="40,*,Auto" ColumnSpacing="12">
                                    <Border Grid.Column="0"
                                            BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D24}"
                                            StrokeThickness="0" StrokeShape="RoundRectangle 10"
                                            HeightRequest="40" WidthRequest="40">
                                        <mi:MauiIcon Icon="{mi:Fluent CalendarAgenda24}" IconSize="22" IconColor="{DynamicResource PageText}" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="{Binding Label}" FontFamily="OpenSansSemibold" FontSize="15" />
                                            <Label Text="{Binding TimeDisplay}" FontSize="14"
                                                   TextColor="{DynamicResource CurrentPrimary}" FontFamily="OpenSansSemibold" />
                                        </HorizontalStackLayout>
                                        <Label Style="{StaticResource SubtleTextStyle}">
                                            <Label.Text>
                                                <MultiBinding StringFormat="{}{0} · {1}">
                                                    <Binding Path="ScheduleType" />
                                                    <Binding Path="ReminderDisplay" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </VerticalStackLayout>
                                    <mi:MauiIcon Grid.Column="2" Icon="{mi:Fluent Edit24}" IconSize="18"
                                                 IconColor="{DynamicResource PageTextSecondary}"
                                                 VerticalOptions="Center"
                                                 IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:ScheduleViewModel}}, x:DataType=vm:ScheduleViewModel, Path=CanEdit}" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>
            </VerticalStackLayout>
            </ScrollView>
    </Grid>

</ContentPage>
