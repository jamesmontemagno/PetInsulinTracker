<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PetInsulinTracker.ViewModels"
             xmlns:models="clr-namespace:PetInsulinTracker.Models"
             xmlns:controls="clr-namespace:PetInsulinTracker.Controls"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="PetInsulinTracker.Views.PetListPage"
             x:DataType="vm:PetListViewModel"
             Title="My Pets"
             BackgroundColor="{DynamicResource PageBackground}">

    <ContentPage.ToolbarItems>

        <ToolbarItem Text="Add"
                     Command="{Binding GoToAddPetCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="{mi:Fluent Add24}" Color="{DynamicResource PageText}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
        <ToolbarItem Text="Settings"
                     Command="{Binding GoToSettingsCommand}">
            <ToolbarItem.IconImageSource>
                <FontImageSource Glyph="{mi:Fluent Settings24}"  Color="{DynamicResource PageText}" />
            </ToolbarItem.IconImageSource>
        </ToolbarItem>
    </ContentPage.ToolbarItems>

    <RefreshView Command="{Binding LoadPetsCommand}"
                 IsRefreshing="{Binding IsRefreshing}">
        <CollectionView ItemsSource="{Binding Pets}"
                        SelectionMode="None">
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="16" Padding="40">
                    <mi:MauiIcon Icon="{mi:Fluent AnimalDog24}" IconSize="64" IconColor="{DynamicResource PageTextSecondary}" HorizontalOptions="Center" />
                    <Label Text="No pets yet"
                           FontSize="20" FontFamily="OpenSansSemibold"
                           HorizontalOptions="Center"
                           TextColor="{DynamicResource PageText}" />
                    <Label Text="Tap + in the toolbar to add your first furry friend!"
                           FontSize="14" HorizontalOptions="Center" HorizontalTextAlignment="Center"
                           TextColor="{DynamicResource PageTextSecondary}" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.Header>
                <VerticalStackLayout Padding="20,24,20,8">
                    <Label Text="Your Pets" Style="{StaticResource SectionHeaderStyle}" />
                </VerticalStackLayout>
            </CollectionView.Header>
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:PetListItemViewModel">
                    <Border Style="{StaticResource CardStyle}" Margin="20,0" Padding="16">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PetListViewModel}}, x:DataType=vm:PetListViewModel, Path=GoToPetDetailCommand}"
                                CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="96,*,Auto" ColumnSpacing="16">
                            <!-- Larger Avatar -->
                            <Border Grid.Column="0" 
                                    BackgroundColor="{DynamicResource CurrentPrimary}"
                                    StrokeThickness="0"
                                    HeightRequest="96"
                                    WidthRequest="96"
                                    StrokeShape="RoundRectangle 20">
                                <Grid>
                                    <mi:MauiIcon Icon="{mi:Fluent AnimalDog24}" IconSize="40" IconColor="White"
                                           HorizontalOptions="Center" VerticalOptions="Center"
                                           IsVisible="{Binding Pet.PhotoSource, Converter={StaticResource IsNotNullOrEmptyConverter}, ConverterParameter=invert}" />
                                    <Image Source="{Binding Pet.PhotoSource}" Aspect="AspectFill"
                                           IsVisible="{Binding Pet.PhotoSource, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                </Grid>
                            </Border>
                            <!-- Pet Info -->
                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="6">
                                <Label Text="{Binding Pet.Name}"
                                       FontSize="20" FontFamily="OpenSansSemibold"
                                       SemanticProperties.HeadingLevel="Level3" />
                                <Label Text="{Binding Pet.Species}"
                                       FontSize="15"
                                       Style="{StaticResource SubtleTextStyle}" />
                                <HorizontalStackLayout Spacing="6" IsVisible="{Binding ShowWeight}">
                                    <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                            StrokeThickness="0"
                                            Padding="8,4"
                                            StrokeShape="RoundRectangle 8">
                                        <Label Style="{StaticResource SubtleTextStyle}" FontSize="13">
                                            <Label.Text>
                                                <MultiBinding StringFormat="{}{0:F1} {1}">
                                                    <Binding Path="Pet.CurrentWeight" />
                                                    <Binding Path="Pet.WeightUnit" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </Border>
                                </HorizontalStackLayout>
                                <!-- Last Insulin & Feeding -->
                                <VerticalStackLayout Spacing="2" Margin="0,4,0,0">
                                    <Label Text="{Binding LastInsulinText, StringFormat='ðŸ’‰ {0}'}"
                                           Style="{StaticResource SubtleTextStyle}"
                                           FontSize="12"
                                           IsVisible="{Binding ShowLastInsulin}" />
                                    <Label Text="{Binding LastFeedingText, StringFormat='ðŸ½ï¸ {0}'}"
                                           Style="{StaticResource SubtleTextStyle}"
                                           FontSize="12"
                                           IsVisible="{Binding ShowLastFeeding}" />
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                            <!-- Chevron -->
                            <mi:MauiIcon Grid.Column="2" Icon="{mi:Fluent ChevronRight24}" IconSize="20" IconColor="{DynamicResource PageTextSecondary}"
                                   VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            <CollectionView.Footer>
                <VerticalStackLayout Padding="20,12" IsVisible="{Binding IsSyncing}">
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="8">
                        <ActivityIndicator IsRunning="{Binding IsSyncing}" HeightRequest="16" WidthRequest="16"
                                           Color="{DynamicResource Primary}" VerticalOptions="Center" />
                        <Label Text="Syncingâ€¦" Style="{StaticResource SubtleTextStyle}" FontSize="12"
                               VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </CollectionView.Footer>
        </CollectionView>
    </RefreshView>

</ContentPage>
