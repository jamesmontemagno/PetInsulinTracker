<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PetInsulinTracker.ViewModels"
             xmlns:controls="clr-namespace:PetInsulinTracker.Controls"
             xmlns:models="clr-namespace:PetInsulinTracker.Models"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="PetInsulinTracker.Views.PetDetailPage"
             x:DataType="vm:PetDetailViewModel"
             Title="{Binding Pet.Name}"
             BackgroundColor="{DynamicResource PageBackground}">

    <ScrollView>
        <VerticalStackLayout Spacing="16">

            <!-- Hero Header with Gradient -->
            <Grid HeightRequest="160">
                <controls:GradientCard
                    StartColor="{AppThemeBinding Light={StaticResource Primary}, Dark=#2A1820}"
                    EndColor="{AppThemeBinding Light={StaticResource Secondary}, Dark=#1A1015}" />
                <Image Source="{Binding Pet.PhotoPath}" Aspect="AspectFill" Opacity="0.3"
                       IsVisible="{Binding Pet.PhotoPath, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
            </Grid>

            <!-- Pet Info Overlay (overlaps hero) -->
            <Border Style="{StaticResource CardStyleElevated}" Margin="20,-60,20,0">
                <VerticalStackLayout Spacing="4">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding Pet.Name}" FontSize="24" FontFamily="OpenSansSemibold"
                                   SemanticProperties.HeadingLevel="Level1" />
                            <Label Style="{StaticResource SubtleTextStyle}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0} Â· {1}">
                                        <Binding Path="Pet.Species" />
                                        <Binding Path="Pet.Breed" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                            <Label Text="{Binding Pet.InsulinType, StringFormat='Insulin: {0}'}"
                                   Style="{StaticResource SubtleTextStyle}" />
                            <Label Text="{Binding DoseInfoText}" Style="{StaticResource SubtleTextStyle}" />
                        </VerticalStackLayout>
                        <Button Grid.Column="1" Text="Edit"
                                Style="{StaticResource GhostButtonStyle}"
                                Command="{Binding GoToEditPetCommand}"
                                IsVisible="{Binding IsOwnerOrFull}"
                                SemanticProperties.Hint="Edit pet" />
                    </Grid>
                    <HorizontalStackLayout Spacing="6" IsVisible="{Binding IsSyncing}">
                        <ActivityIndicator IsRunning="{Binding IsSyncing}" HeightRequest="14" WidthRequest="14"
                                           Color="{DynamicResource Primary}" />
                        <Label Text="Syncingâ€¦" Style="{StaticResource SubtleTextStyle}" FontSize="12" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <Border Style="{StaticResource CardStyle}" Margin="20,8,20,0"
                    IsVisible="{Binding IsGuest}" Padding="12,8">
                <Label Text="ðŸ‘¤ Guest Access â€” You can log entries but cannot edit pet info"
                       Style="{StaticResource SubtleTextStyle}" FontSize="12"
                       HorizontalTextAlignment="Center" />
            </Border>

            <VerticalStackLayout Padding="20,0" Spacing="16">

                <!-- Dose Indicator + Quick Log -->
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                    <controls:DoseIndicator Grid.Column="0"
                                            WidthRequest="100" HeightRequest="100"
                                            Progress="{Binding DoseProgress}"
                                            CenterText="{Binding DoseCountdownText}"
                                            SubText="{Binding DoseCountdownSubText}"
                                            RingColor="{DynamicResource CurrentPrimary}"
                                            TrackColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                            CenterTextColor="{DynamicResource PageText}" />
                    <Button Grid.Column="1"
                            Text="Quick Log Insulin"
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding QuickLogInsulinCommand}"
                            VerticalOptions="Center"
                            SemanticProperties.Hint="Log insulin at current dose and time" />
                </Grid>

                <!-- Feeding Indicator + Quick Log -->
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                    <controls:DoseIndicator Grid.Column="0"
                                            WidthRequest="100" HeightRequest="100"
                                            Progress="{Binding FeedingProgress}"
                                            CenterText="{Binding FeedingCountdownText}"
                                            SubText="{Binding FeedingCountdownSubText}"
                                            RingColor="{AppThemeBinding Light=#4CAF50, Dark=#66BB6A}"
                                            TrackColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                                            CenterTextColor="{DynamicResource PageText}" />
                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="8">
                        <Button Text="Quick Log Feeding"
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding QuickLogFeedingCommand}"
                                SemanticProperties.Hint="Log feeding with default food" />
                        <Label Text="{Binding QuickFeedInfoText}" Style="{StaticResource SubtleTextStyle}" FontSize="12" />
                    </VerticalStackLayout>
                </Grid>

                <!-- Recent Activity -->
                <Label Text="RECENT ACTIVITY" Style="{StaticResource OverlineStyle}" />

                <!-- Last Insulin Card -->
                <Border Style="{StaticResource CardStyle}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToInsulinLogCommand}" />
                    </Border.GestureRecognizers>
                    <Grid ColumnDefinitions="40,*,Auto" ColumnSpacing="12">
                        <Border Grid.Column="0" BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#3D2C1E}"
                                StrokeThickness="0" StrokeShape="RoundRectangle 10"
                                HeightRequest="40" WidthRequest="40">
                            <mi:MauiIcon Icon="{mi:Fluent Syringe24}" IconSize="22" IconColor="{DynamicResource PageText}" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                            <Label Text="Last Insulin" FontFamily="OpenSansSemibold" FontSize="14" />
                            <Label Text="{Binding LastInsulinText}" Style="{StaticResource SubtleTextStyle}" />
                        </VerticalStackLayout>
                        <mi:MauiIcon Grid.Column="2" Icon="{mi:Fluent ChevronRight24}" IconSize="16" IconColor="{DynamicResource PageTextSecondary}" VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!-- Last Feeding Card -->
                <Border Style="{StaticResource CardStyle}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToFeedingLogCommand}" />
                    </Border.GestureRecognizers>
                    <Grid ColumnDefinitions="40,*,Auto" ColumnSpacing="12">
                        <Border Grid.Column="0" BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D24}"
                                StrokeThickness="0" StrokeShape="RoundRectangle 10"
                                HeightRequest="40" WidthRequest="40">
                            <mi:MauiIcon Icon="{mi:Fluent Food24}" IconSize="22" IconColor="{DynamicResource PageText}" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                            <Label Text="Last Feeding" FontFamily="OpenSansSemibold" FontSize="14" />
                            <Label Text="{Binding LastFeedingText}" Style="{StaticResource SubtleTextStyle}" />
                        </VerticalStackLayout>
                        <mi:MauiIcon Grid.Column="2" Icon="{mi:Fluent ChevronRight24}" IconSize="16" IconColor="{DynamicResource PageTextSecondary}" VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!-- Last Weight Card -->
                <Border Style="{StaticResource CardStyle}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToWeightLogCommand}" />
                    </Border.GestureRecognizers>
                    <Grid ColumnDefinitions="40,*,Auto" ColumnSpacing="12">
                        <Border Grid.Column="0" BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A2A3D}"
                                StrokeThickness="0" StrokeShape="RoundRectangle 10"
                                HeightRequest="40" WidthRequest="40">
                            <mi:MauiIcon Icon="{mi:Fluent Scales24}" IconSize="22" IconColor="{DynamicResource PageText}" HorizontalOptions="Center" VerticalOptions="Center" />
                        </Border>
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                            <Label Text="Weight" FontFamily="OpenSansSemibold" FontSize="14" />
                            <Label Text="{Binding LastWeightText}" Style="{StaticResource SubtleTextStyle}" />
                        </VerticalStackLayout>
                        <mi:MauiIcon Grid.Column="2" Icon="{mi:Fluent ChevronRight24}" IconSize="16" IconColor="{DynamicResource PageTextSecondary}" VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!-- Active Schedules -->
                <Label Text="ACTIVE SCHEDULES" Style="{StaticResource OverlineStyle}" Margin="0,8,0,0"
                       IsVisible="{Binding ActiveSchedules.Count, Converter={StaticResource IsNotNullOrEmptyConverter}}" />

                <CollectionView ItemsSource="{Binding ActiveSchedules}" SelectionMode="None"
                                IsVisible="{Binding ActiveSchedules.Count, Converter={StaticResource IsNotNullOrEmptyConverter}}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Schedule">
                            <Border Style="{StaticResource CardStyle}">
                                <Grid ColumnDefinitions="40,*" ColumnSpacing="12">
                                    <Border Grid.Column="0"
                                            BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D24}"
                                            StrokeThickness="0" StrokeShape="RoundRectangle 10"
                                            HeightRequest="40" WidthRequest="40">
                                        <mi:MauiIcon Icon="{mi:Fluent CalendarAgenda24}" IconSize="22" IconColor="{DynamicResource PageText}" HorizontalOptions="Center" VerticalOptions="Center" />
                                    </Border>
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="{Binding Label}" FontFamily="OpenSansSemibold" FontSize="14" />
                                            <Label Text="{Binding TimeDisplay}" FontSize="13"
                                                   TextColor="{DynamicResource CurrentPrimary}" FontFamily="OpenSansSemibold" />
                                        </HorizontalStackLayout>
                                        <Label Style="{StaticResource SubtleTextStyle}" FontSize="12">
                                            <Label.Text>
                                                <MultiBinding StringFormat="{}{0} Â· {1}">
                                                    <Binding Path="ScheduleType" />
                                                    <Binding Path="ReminderDisplay" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Manage Section -->
                <Label Text="MANAGE" Style="{StaticResource OverlineStyle}" Margin="0,8,0,0" />

                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="12">
                    <Button Grid.Row="0" Grid.Column="0" Text="Schedules"
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding GoToScheduleCommand}"
                            IsVisible="{Binding IsOwnerOrFull}" />
                    <Button Grid.Row="0" Grid.Column="1" Text="Vet Info"
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding GoToVetInfoCommand}"
                            IsVisible="{Binding IsOwnerOrFull}" />
                    <Button Grid.Row="1" Grid.Column="0" Text="Share"
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding GoToShareCommand}"
                            IsVisible="{Binding IsOwner}" />
                    <Button Grid.Row="1" Grid.Column="1" Text="Settings"
                            Style="{StaticResource OutlineButtonStyle}"
                            Command="{Binding GoToSettingsCommand}" />
                </Grid>

                <Button Text="Sync Now"
                        Style="{StaticResource OutlineButtonStyle}"
                        Command="{Binding SyncNowCommand}"
                        IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}"
                        SemanticProperties.Hint="Sync pet data with cloud" />

                <!-- Sync Status -->
                <Border Style="{StaticResource CardStyle}" Padding="12,8">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                        <ActivityIndicator Grid.Column="0"
                                           IsRunning="{Binding IsSyncing}"
                                           IsVisible="{Binding IsSyncing}"
                                           HeightRequest="18" WidthRequest="18"
                                           Color="{DynamicResource Primary}"
                                           VerticalOptions="Center" />
                        <Label Grid.Column="1"
                               Text="{Binding SyncStatus}"
                               Style="{StaticResource SubtleTextStyle}"
                               FontSize="12"
                               VerticalOptions="Center" />
                    </Grid>
                </Border>

                <!-- Bottom spacing -->
                <BoxView HeightRequest="20" BackgroundColor="Transparent" />

            </VerticalStackLayout>
        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
